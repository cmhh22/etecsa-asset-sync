{% extends "base.html" %}

{% block title %}Dashboard — ETECSA Asset Sync{% endblock %}
{% block nav_dashboard %}active{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                    <i class="bi bi-pc-display"></i>
                </div>
                <div>
                    <div class="stat-value">{{ total_assets }}</div>
                    <div class="stat-label">Total Activos</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-success bg-opacity-10 text-success">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div>
                    <div class="stat-value">{{ with_tag }}</div>
                    <div class="stat-label">Con TAG</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div>
                    <div class="stat-value">{{ without_tag }}</div>
                    <div class="stat-label">Sin TAG</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-info bg-opacity-10 text-info">
                    <i class="bi bi-cloud"></i>
                </div>
                <div>
                    <div class="stat-value">{{ virtual_machines }}</div>
                    <div class="stat-label">Máquinas Virtuales</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- TAG Status Doughnut -->
    <div class="col-lg-5">
        <div class="card content-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-pie-chart me-2"></i>Estado de TAGs</span>
                <span class="badge bg-primary badge-etecsa">{{ tag_percentage }}% completado</span>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="tagStatusChart" style="max-height: 280px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Buildings Bar Chart -->
    <div class="col-lg-7">
        <div class="card content-card h-100">
            <div class="card-header">
                <i class="bi bi-building me-2"></i>Activos por Edificio
            </div>
            <div class="card-body">
                <canvas id="buildingsChart" style="max-height: 280px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Row -->
<div class="row g-4">
    <!-- Quick Actions -->
    <div class="col-lg-4">
        <div class="card content-card h-100">
            <div class="card-header">
                <i class="bi bi-lightning me-2"></i>Acciones Rápidas
            </div>
            <div class="card-body d-grid gap-2">
                <form action="{% url 'actualizar_tags' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-etecsa w-100" onclick="showLoading()">
                        <i class="bi bi-arrow-repeat me-2"></i>Sincronizar TAGs
                    </button>
                </form>
                <a href="{% url 'accountinfo' %}" class="btn btn-outline-primary">
                    <i class="bi bi-table me-2"></i>Ver Inventario Completo
                </a>
                <a href="{% url 'mostrar_reportes' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>Ver Reportes
                </a>
                <a href="{% url 'exportar_reportes' %}" class="btn btn-outline-success">
                    <i class="bi bi-download me-2"></i>Descargar Excel de Reportes
                </a>
                <a href="{% url 'descargar_registros' %}" class="btn btn-outline-dark">
                    <i class="bi bi-file-text me-2"></i>Descargar Log de Sincronización
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Assets -->
    <div class="col-lg-8">
        <div class="card content-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>Últimos Registros</span>
                <a href="{% url 'accountinfo' %}" class="btn btn-sm btn-outline-primary">Ver todos</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-modern mb-0">
                        <thead>
                            <tr>
                                <th>HW ID</th>
                                <th>Inventario</th>
                                <th>TAG</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in recent_assets %}
                            <tr>
                                <td><code>{{ asset.hardware_id }}</code></td>
                                <td>{{ asset.fields_3|default:"—" }}</td>
                                <td>
                                    {% if asset.tag %}
                                        <span class="badge bg-success badge-etecsa">{{ asset.tag }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary badge-etecsa">Sin TAG</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.fields_3 == "MV" %}
                                        <span class="badge bg-info badge-etecsa">VM</span>
                                    {% elif asset.fields_3 %}
                                        <span class="badge bg-primary badge-etecsa">Físico</span>
                                    {% else %}
                                        <span class="badge bg-warning badge-etecsa">Vacío</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">No hay registros aún</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
    // TAG Status Doughnut Chart
    new Chart(document.getElementById('tagStatusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Con TAG', 'Sin TAG', 'Máquinas Virtuales', 'Inventario Vacío'],
            datasets: [{
                data: [{{ with_tag }}, {{ without_tag }}, {{ virtual_machines }}, {{ empty_inventory }}],
                backgroundColor: ['#38a169', '#e53e3e', '#3182ce', '#d69e2e'],
                borderWidth: 0,
                hoverOffset: 8,
            }]
        },
        options: {
            responsive: true,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 15, usePointStyle: true, pointStyleWidth: 10, font: { size: 12 } }
                }
            }
        }
    });

    // Buildings Bar Chart
    const buildingLabels = {{ building_labels|safe }};
    const buildingCounts = {{ building_counts|safe }};

    if (buildingLabels.length > 0) {
        new Chart(document.getElementById('buildingsChart'), {
            type: 'bar',
            data: {
                labels: buildingLabels.map(l => l.replace(/_/g, ' ')),
                datasets: [{
                    label: 'Activos',
                    data: buildingCounts,
                    backgroundColor: '#3182ce',
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: '#f0f0f0' },
                        ticks: { stepSize: 1 }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
    } else {
        document.getElementById('buildingsChart').parentElement.innerHTML =
            '<div class="text-center text-muted py-5"><i class="bi bi-bar-chart fs-1 d-block mb-2"></i>Ejecute la sincronización para ver datos</div>';
    }
</script>
{% endblock %}
